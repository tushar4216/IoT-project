<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Irrigation Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 800;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            background: #f0f0f0;
            margin-top: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Growth Stage Controls */
        .stage-controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .stage-controls h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .day-display {
            text-align: right;
            margin-bottom: 20px;
        }

        .day-display .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .day-display .current-day {
            font-size: 4em;
            font-weight: 800;
            color: #667eea;
            line-height: 1;
        }

        .day-display .total-days {
            font-size: 0.8em;
            color: #999;
        }

        .day-slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .day-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 10px;
            outline: none;
        }

        .day-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
        }

        .day-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
        }

        .day-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
        }

        .day-btn.minus {
            background: #e0e0e0;
            color: #666;
        }

        .day-btn.plus {
            background: #667eea;
            color: white;
        }

        .day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Growth Stages Timeline */
        .stages-timeline {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stage-card {
            padding: 20px;
            border-radius: 15px;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stage-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            opacity: 0.1;
            z-index: 0;
        }

        .stage-card.inactive {
            background: #f3f4f6;
            opacity: 0.6;
        }

        .stage-card.active {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            animation: stageGlow 2s infinite alternate;
        }

        @keyframes stageGlow {
            from { box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); }
            to { box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3); }
        }

        .stage-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .stage-card.active .stage-icon {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .stage-name {
            font-size: 1em;
            font-weight: 700;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .stage-days {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .stage-moisture {
            font-size: 0.9em;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            position: relative;
            z-index: 1;
        }

        /* Current Status Card */
        .current-status-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .current-status-card h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .active-stage-banner {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid;
        }

        .active-stage-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .active-stage-desc {
            font-size: 0.95em;
            opacity: 0.8;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .sensor-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s;
        }

        .sensor-card:hover {
            transform: translateY(-5px);
        }

        .sensor-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .sensor-title {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .sensor-value {
            font-size: 3em;
            font-weight: 800;
            color: #667eea;
        }

        .sensor-unit {
            font-size: 0.4em;
            color: #999;
        }

        .moisture-indicator {
            margin-top: 20px;
        }

        .moisture-bar-container {
            height: 12px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .moisture-bar {
            height: 100%;
            transition: width 0.5s ease, background-color 0.5s ease;
            border-radius: 10px;
        }

        .moisture-status {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .moisture-status .target {
            color: #666;
        }

        .moisture-status .status {
            font-weight: 600;
        }

        .status-optimal {
            color: #4CAF50;
        }

        .status-warning {
            color: #ff9800;
        }

        .status-critical {
            color: #f44336;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .chart-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .control-panel h2 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .relay-control {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .relay-btn {
            padding: 20px 40px;
            font-size: 1.2em;
            flex: 1;
            min-width: 200px;
        }

        .relay-btn.off {
            background: #e0e0e0;
            color: #666;
        }

        .relay-btn.on {
            background: #667eea;
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            animation: valveOn 1s infinite alternate;
        }

        @keyframes valveOn {
            from { box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
            to { box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6); }
        }

        .mode-toggle {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
        }

        .mode-toggle.auto {
            background: #4CAF50;
            color: white;
        }

        .mode-toggle.manual {
            background: #ff9800;
            color: white;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 8px;
            border-left: 3px solid transparent;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .log-entry.success {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }

        .log-entry.info {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }

        .log-entry.warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .timestamp {
            color: #667eea;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 800;
            margin-top: 5px;
        }

        /* Stage Requirements Table */
        .requirements-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .requirements-table h2 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 700;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            text-align: left;
            padding: 15px;
            font-weight: 700;
            color: #667eea;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr.active-row {
            background: #e3f2fd;
        }

        .table-stage-icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .table-moisture-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: 600;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .stages-timeline {
                grid-template-columns: repeat(2, 1fr);
            }

            .day-display .current-day {
                font-size: 3em;
            }

            .relay-control {
                flex-direction: column;
            }

            .relay-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üå± Smart Irrigation Dashboard</h1>
            <p>Nagaral, Karnataka | Real-time Monitoring & Growth Stage Management</p>
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connecting to HiveMQ...</span>
            </div>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Messages Received</div>
                    <div class="stat-value" id="msgCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Data Points Logged</div>
                    <div class="stat-value" id="dataCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Session Duration</div>
                    <div class="stat-value" id="duration">00:00</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Irrigations</div>
                    <div class="stat-value" id="irrigationCount">0</div>
                </div>
            </div>
        </div>

        <!-- Growth Stage Controls -->
        <div class="stage-controls">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                <div>
                    <h2>üåæ Growth Stage Management</h2>
                    <p style="color: #666;">Automated irrigation based on crop growth stages</p>
                </div>
                <div class="day-display">
                    <div class="label">Current Day</div>
                    <div class="current-day" id="currentDayDisplay">1</div>
                    <div class="total-days">of 120 days</div>
                </div>
            </div>

            <div class="day-slider-container">
                <button class="day-btn minus" onclick="changeDay(-1)">-1 Day</button>
                <input type="range" min="1" max="120" value="1" class="day-slider" id="daySlider" oninput="updateDay(this.value)">
                <button class="day-btn plus" onclick="changeDay(1)">+1 Day</button>
            </div>

            <div class="stages-timeline" id="stagesTimeline"></div>
        </div>

        <!-- Current Status -->
        <div class="current-status-card">
            <h2>üìä Current Status</h2>
            <div class="active-stage-banner" id="activeStageBanner">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 2.5em;" id="activeStageIcon">üå±</div>
                    <div>
                        <div class="active-stage-title" id="activeStageName">Initial Growth Stage</div>
                        <div class="active-stage-desc" id="activeStageDesc">Seed germination and early root development</div>
                    </div>
                </div>
            </div>

            <div class="moisture-indicator">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 1.1em; font-weight: 600; color: #666;">Soil Moisture Level</span>
                    <span style="font-size: 2em; font-weight: 800; color: #667eea;" id="avgMoisture">--</span>
                </div>
                <div class="moisture-bar-container">
                    <div class="moisture-bar" id="moistureBar" style="width: 0%; background: #4CAF50;"></div>
                </div>
                <div class="moisture-status">
                    <span class="target">Target: <span id="targetRange">80-90%</span></span>
                    <span class="status" id="moistureStatus">‚ö† Calculating...</span>
                </div>
            </div>
        </div>

        <!-- Sensor Cards -->
        <div class="sensor-grid">
            <div class="sensor-card">
                <div class="sensor-icon">üíß</div>
                <div class="sensor-title">Soil Moisture 1</div>
                <div class="sensor-value">
                    <span id="soil1">--</span><span class="sensor-unit">%</span>
                </div>
            </div>
            <div class="sensor-card">
                <div class="sensor-icon">üíß</div>
                <div class="sensor-title">Soil Moisture 2</div>
                <div class="sensor-value">
                    <span id="soil2">--</span><span class="sensor-unit">%</span>
                </div>
            </div>
            <div class="sensor-card">
                <div class="sensor-icon">üíß</div>
                <div class="sensor-title">Soil Moisture 3</div>
                <div class="sensor-value">
                    <span id="soil3">--</span><span class="sensor-unit">%</span>
                </div>
            </div>
            <div class="sensor-card">
                <div class="sensor-icon">üíß</div>
                <div class="sensor-title">Soil Moisture 4</div>
                <div class="sensor-value">
                    <span id="soil4">--</span><span class="sensor-unit">%</span>
                </div>
            </div>
            <div class="sensor-card">
                <div class="sensor-icon">üå°Ô∏è</div>
                <div class="sensor-title">Soil Temperature</div>
                <div class="sensor-value">
                    <span id="soiltemp">--</span><span class="sensor-unit">¬∞C</span>
                </div>
            </div>
            <div class="sensor-card">
                <div class="sensor-icon">üå°Ô∏è</div>
                <div class="sensor-title">Air Temperature</div>
                <div class="sensor-value">
                    <span id="airtemp">--</span><span class="sensor-unit">¬∞C</span>
                </div>
            </div>
            <div class="sensor-card">
                <div class="sensor-icon">üí®</div>
                <div class="sensor-title">Humidity</div>
                <div class="sensor-value">
                    <span id="humidity">--</span><span class="sensor-unit">%</span>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <h2>üìà Real-time Sensor Data (Last 20 readings)</h2>
            <canvas id="sensorChart"></canvas>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h2>‚ö° Irrigation Control</h2>
            <div class="relay-control">
                <button class="mode-toggle auto" id="modeToggle" onclick="toggleMode()">
                    ü§ñ AUTO MODE
                </button>
                <button class="btn relay-btn off" id="relayBtn" onclick="toggleRelay()">
                    üíß Solenoid Valve<br>OFF
                </button>
            </div>
            <div class="control-buttons">
                <button class="btn btn-success" onclick="downloadCSV()">üì• Download CSV</button>
                <button class="btn btn-primary" onclick="downloadJSON()">üì• Download JSON</button>
                <button class="btn btn-danger" onclick="clearData()">üóëÔ∏è Clear Data</button>
            </div>
        </div>

        <!-- Data Log -->
        <div class="control-panel">
            <h2>üìã Activity Log (Last 15 entries)</h2>
            <div class="log-container" id="dataLog">
                <div class="log-entry info">System initialized. Waiting for sensor data...</div>
            </div>
        </div>

        <!-- Stage Requirements Table -->
        <div class="requirements-table">
            <h2>üìñ Moisture Requirements by Growth Stage</h2>
            <table>
                <thead>
                    <tr>
                        <th>Stage</th>
                        <th>Days</th>
                        <th>Optimal Moisture</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="requirementsTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // MQTT Configuration for HiveMQ Cloud
        const MQTT_BROKER = "wss://232e4faf072542e9866d0d3e0d18b979.s1.eu.hivemq.cloud:8884/mqtt";
        const MQTT_OPTIONS = {
            username: "Tushar4216",
            password: "Tushar@123456789",
            clientId: "WebDashboard_" + Math.random().toString(16).substr(2, 8),
            clean: true,
            reconnectPeriod: 5000,
            connectTimeout: 10000
        };

        // Growth Stages Configuration
        const GROWTH_STAGES = [
            {
                name: 'Initial Growth',
                icon: 'üå±',
                moistureRange: [80, 90],
                days: [1, 15],
                color: '#4ade80',
                bgColor: '#dcfce7',
                description: 'Seed germination and early root development'
            },
            {
                name: 'Vegetative',
                icon: 'üìà',
                moistureRange: [70, 80],
                days: [16, 45],
                color: '#22c55e',
                bgColor: '#d1fae5',
                description: 'Rapid leaf and stem growth'
            },
            {
                name: 'Flowering',
                icon: 'üå∏',
                moistureRange: [85, 95],
                days: [46, 80],
                color: '#ec4899',
                bgColor: '#fce7f3',
                description: 'Flower development and pollination'
            },
            {
                name: 'Grain Filling',
                icon: 'üåæ',
                moistureRange: [75, 85],
                days: [81, 105],
                color: '#f59e0b',
                bgColor: '#fef3c7',
                description: 'Grain development and weight gain'
            },
            {
                name: 'Maturity',
                icon: 'üíß',
                moistureRange: [60, 70],
                days: [106, 120],
                color: '#eab308',
                bgColor: '#fef9c3',
                description: 'Ripening and harvest preparation'
            }
        ];

        let client;
        let relayState = false;
        let autoMode = true;
        let sensorData = [];
        let chart;
        let messageCount = 0;
        let irrigationCount = 0;
        let startTime = Date.now();
        let currentDay = 1;
        let currentStageIndex = 0;
        let soilMoistureValues = { soil1: 0, soil2: 0, soil3: 0, soil4: 0 };

        // Initialize chart
        const ctx = document.getElementById('sensorChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Avg Moisture (%)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    },
                    {
                        label: 'Air Temp (¬∞C)',
                        data: [],
                        borderColor: '#ff6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    },
                    {
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#36a2eb',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        enabled: true
                    }
                }
            }
        });

        // Initialize UI
        function initializeUI() {
            renderStagesTimeline();
            renderRequirementsTable();
            updateCurrentStage();
        }

        function renderStagesTimeline() {
            const timeline = document.getElementById('stagesTimeline');
            timeline.innerHTML = GROWTH_STAGES.map((stage, index) => `
                <div class="stage-card ${index === currentStageIndex ? 'active' : 'inactive'}" 
                     id="stageCard${index}"
                     style="background: ${index === currentStageIndex ? stage.color : '#f3f4f6'}; color: ${index === currentStageIndex ? 'white' : '#666'};">
                    <div class="stage-icon">${stage.icon}</div>
                    <div class="stage-name">${stage.name}</div>
                    <div class="stage-days">Days ${stage.days[0]}-${stage.days[1]}</div>
                    <div class="stage-moisture" style="background: ${index === currentStageIndex ? 'rgba(255,255,255,0.3)' : stage.bgColor}; color: ${index === currentStageIndex ? 'white' : stage.color};">
                        ${stage.moistureRange[0]}-${stage.moistureRange[1]}%
                    </div>
                </div>
            `).join('');
        }

        function renderRequirementsTable() {
            const tbody = document.getElementById('requirementsTableBody');
            tbody.innerHTML = GROWTH_STAGES.map((stage, index) => `
                <tr class="${index === currentStageIndex ? 'active-row' : ''}" id="tableRow${index}">
                    <td>
                        <div class="table-stage-icon">
                            <span>${stage.icon}</span>
                            <span>${stage.name}</span>
                        </div>
                    </td>
                    <td>${stage.days[0]}-${stage.days[1]}</td>
                    <td>
                        <span class="table-moisture-badge">
                            ${stage.moistureRange[0]}-${stage.moistureRange[1]}%
                        </span>
                    </td>
                    <td>${stage.description}</td>
                </tr>
            `).join('');
        }

        function determineStage(day) {
            for (let i = 0; i < GROWTH_STAGES.length; i++) {
                if (day >= GROWTH_STAGES[i].days[0] && day <= GROWTH_STAGES[i].days[1]) {
                    return i;
                }
            }
            return 4;
        }

        function updateDay(day) {
            currentDay = parseInt(day);
            document.getElementById('currentDayDisplay').textContent = currentDay;
            document.getElementById('daySlider').value = currentDay;
            
            const newStage = determineStage(currentDay);
            if (newStage !== currentStageIndex) {
                currentStageIndex = newStage;
                addLog(`Growth stage changed to: ${GROWTH_STAGES[currentStageIndex].name}`, 'warning');
                updateCurrentStage();
            }
        }

        function changeDay(delta) {
            const newDay = Math.max(1, Math.min(120, currentDay + delta));
            updateDay(newDay);
        }

        function updateCurrentStage() {
            const stage = GROWTH_STAGES[currentStageIndex];
            
            // Update timeline
            renderStagesTimeline();
            
            // Update table
            document.querySelectorAll('#requirementsTableBody tr').forEach((row, index) => {
                row.className = index === currentStageIndex ? 'active-row' : '';
            });
            
            // Update active stage banner
            const banner = document.getElementById('activeStageBanner');
            banner.style.background = stage.bgColor;
            banner.style.borderLeftColor = stage.color;
            document.getElementById('activeStageIcon').textContent = stage.icon;
            document.getElementById('activeStageName').textContent = stage.name + ' Stage';
            document.getElementById('activeStageDesc').textContent = stage.description;
            document.getElementById('targetRange').textContent = `${stage.moistureRange[0]}-${stage.moistureRange[1]}%`;
            
            // Check if irrigation needed
            checkIrrigationNeeded();
        }

        function calculateAverageMoisture() {
            const values = Object.values(soilMoistureValues).filter(v => v > 0);
            if (values.length === 0) return 0;
            return values.reduce((a, b) => a + b, 0) / values.length;
        }

        function updateMoistureDisplay() {
            const avgMoisture = calculateAverageMoisture();
            if (avgMoisture === 0) return;

            document.getElementById('avgMoisture').textContent = avgMoisture.toFixed(1) + '%';
            
            const stage = GROWTH_STAGES[currentStageIndex];
            const [minMoisture, maxMoisture] = stage.moistureRange;
            
            // Update bar
            const bar = document.getElementById('moistureBar');
            bar.style.width = avgMoisture + '%';
            
            // Determine status
            let status, statusClass, barColor;
            if (avgMoisture >= minMoisture && avgMoisture <= maxMoisture) {
                status = '‚úì Optimal';
                statusClass = 'status-optimal';
                barColor = '#4CAF50';
            } else if (avgMoisture < minMoisture - 10) {
                status = '‚ö† Critical - Irrigation Required';
                statusClass = 'status-critical';
                barColor = '#f44336';
            } else if (avgMoisture < minMoisture) {
                status = '‚ö† Low - Action Needed';
                statusClass = 'status-warning';
                barColor = '#ff9800';
            } else {
                status = '‚ö† High';
                statusClass = 'status-warning';
                barColor = '#ff9800';
            }
            
            bar.style.background = barColor;
            const statusEl = document.getElementById('moistureStatus');
            statusEl.textContent = status;
            statusEl.className = 'status ' + statusClass;
        }

        function checkIrrigationNeeded() {
            if (!autoMode) return;

            const avgMoisture = calculateAverageMoisture();
            if (avgMoisture === 0) return;

            const stage = GROWTH_STAGES[currentStageIndex];
            const [minMoisture, maxMoisture] = stage.moistureRange;
            const threshold = minMoisture - 5;
            const targetMoisture = (minMoisture + maxMoisture) / 2;

            if (avgMoisture < threshold && !relayState) {
                controlValve(true, `Moisture ${avgMoisture.toFixed(1)}% < ${threshold}% (Stage: ${stage.name})`);
            } else if (avgMoisture >= targetMoisture && relayState) {
                controlValve(false, `Target moisture ${targetMoisture}% reached`);
            }
        }

        function toggleMode() {
            autoMode = !autoMode;
            const btn = document.getElementById('modeToggle');
            if (autoMode) {
                btn.className = 'mode-toggle auto';
                btn.textContent = 'ü§ñ AUTO MODE';
                addLog('Switched to AUTO mode - Stage-based control active', 'info');
                checkIrrigationNeeded();
            } else {
                btn.className = 'mode-toggle manual';
                btn.textContent = 'üë§ MANUAL MODE';
                addLog('Switched to MANUAL mode - Manual control enabled', 'warning');
            }
        }

        function controlValve(shouldOpen, reason) {
            if (shouldOpen === relayState) return;

            if (!client || !client.connected) {
                console.error('Not connected to MQTT');
                return;
            }

            relayState = shouldOpen;
            const message = JSON.stringify({ state: relayState });
            
            client.publish("somaiya/irrigation/relay/control", message, { qos: 1 }, (err) => {
                if (err) {
                    console.error("Publish error:", err);
                } else {
                    updateRelayButton();
                    const action = shouldOpen ? 'OPENED' : 'CLOSED';
                    addLog(`Valve ${action}: ${reason}`, shouldOpen ? 'success' : 'info');
                    
                    if (shouldOpen) {
                        irrigationCount++;
                        document.getElementById('irrigationCount').textContent = irrigationCount;
                    }
                }
            });
        }

        function toggleRelay() {
            if (!client || !client.connected) {
                alert('Not connected to MQTT broker!');
                return;
            }

            if (autoMode) {
                alert('Switch to MANUAL mode first to control the valve manually');
                return;
            }

            controlValve(!relayState, 'Manual override');
        }

        function updateRelayButton() {
            const btn = document.getElementById('relayBtn');
            if (relayState) {
                btn.classList.remove('off');
                btn.classList.add('on');
                btn.innerHTML = 'üíß Solenoid Valve<br>ON';
            } else {
                btn.classList.remove('on');
                btn.classList.add('off');
                btn.innerHTML = 'üíß Solenoid Valve<br>OFF';
            }
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('dataLog');
            const logHTML = `
                <div class="log-entry ${type}">
                    <span class="timestamp">[${timestamp}]</span> ${message}
                </div>
            `;
            
            logContainer.innerHTML = logHTML + logContainer.innerHTML;

            // Keep only last 15 entries
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 15) {
                entries[entries.length - 1].remove();
            }
        }

        // Update session duration
        setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('duration').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);

        // Connect to MQTT
        function connectMQTT() {
            console.log("Connecting to HiveMQ Cloud...");

            try {
                client = mqtt.connect(MQTT_BROKER, MQTT_OPTIONS);

                client.on('connect', () => {
                    console.log("‚úì Connected to HiveMQ Cloud!");
                    document.getElementById('statusDot').classList.add('connected');
                    document.getElementById('statusText').textContent = 'Connected to HiveMQ Cloud ‚úì';

                    // Subscribe to all topics
                    const topics = [
                        "somaiya/irrigation/soil1",
                        "somaiya/irrigation/soil2",
                        "somaiya/irrigation/soil3",
                        "somaiya/irrigation/soil4",
                        "somaiya/irrigation/soiltemp",
                        "somaiya/irrigation/airtemp",
                        "somaiya/irrigation/humidity",
                        "somaiya/irrigation/relay/status"
                    ];

                    topics.forEach(topic => {
                        client.subscribe(topic, (err) => {
                            if (!err) {
                                console.log("Subscribed to:", topic);
                            }
                        });
                    });

                    addLog('Connected to HiveMQ Cloud successfully', 'success');
                });

                client.on('message', (topic, message) => {
                    messageCount++;
                    document.getElementById('msgCount').textContent = messageCount;

                    try {
                        const payload = JSON.parse(message.toString());
                        handleMessage(topic, payload);
                    } catch (e) {
                        console.error("Parse error:", e);
                    }
                });

                client.on('error', (error) => {
                    console.error("MQTT Error:", error);
                    document.getElementById('statusText').textContent = 'Connection Error';
                    addLog('MQTT Connection Error: ' + error.message, 'warning');
                });

                client.on('offline', () => {
                    document.getElementById('statusDot').classList.remove('connected');
                    document.getElementById('statusText').textContent = 'Offline - Reconnecting...';
                    addLog('Connection lost - attempting to reconnect', 'warning');
                });

            } catch (error) {
                console.error("Connection failed:", error);
                document.getElementById('statusText').textContent = 'Connection Failed';
                addLog('Connection Failed: ' + error.message, 'warning');
            }
        }

        function handleMessage(topic, payload) {
            const topicName = topic.split('/').pop();

            // Update sensor values
            if (topicName === "soil1") {
                document.getElementById('soil1').textContent = payload.value;
                soilMoistureValues.soil1 = payload.value;
                updateMoistureDisplay();
                checkIrrigationNeeded();
            } else if (topicName === "soil2") {
                document.getElementById('soil2').textContent = payload.value;
                soilMoistureValues.soil2 = payload.value;
                updateMoistureDisplay();
                checkIrrigationNeeded();
            } else if (topicName === "soil3") {
                document.getElementById('soil3').textContent = payload.value;
                soilMoistureValues.soil3 = payload.value;
                updateMoistureDisplay();
                checkIrrigationNeeded();
            } else if (topicName === "soil4") {
                document.getElementById('soil4').textContent = payload.value;
                soilMoistureValues.soil4 = payload.value;
                updateMoistureDisplay();
                checkIrrigationNeeded();
            } else if (topicName === "soiltemp") {
                document.getElementById('soiltemp').textContent = payload.value.toFixed(1);
            } else if (topicName === "airtemp") {
                document.getElementById('airtemp').textContent = payload.value.toFixed(1);
                updateChart(1, payload.value);
            } else if (topicName === "humidity") {
                document.getElementById('humidity').textContent = payload.value.toFixed(1);
                updateChart(2, payload.value);
            } else if (topicName === "status") {
                relayState = payload.state;
                updateRelayButton();
            }

            // Log data
            logData(topicName, payload);
        }

        function updateChart(datasetIndex, value) {
            const now = new Date().toLocaleTimeString();
            
            // Update average moisture in chart
            if (datasetIndex === 1 || datasetIndex === 2) {
                const avgMoisture = calculateAverageMoisture();
                if (avgMoisture > 0 && (chart.data.labels.length === 0 || chart.data.labels[chart.data.labels.length - 1] !== now)) {
                    if (chart.data.labels.length >= 20) {
                        chart.data.labels.shift();
                        chart.data.datasets.forEach(dataset => dataset.data.shift());
                    }
                    chart.data.labels.push(now);
                    chart.data.datasets[0].data.push(avgMoisture);
                }
            }

            // Update other datasets
            if (chart.data.labels.length > 0) {
                chart.data.datasets[datasetIndex].data.push(value);
            }

            chart.update('none');
        }

        function logData(topic, payload) {
            const timestamp = new Date().toLocaleString();
            const logEntry = {
                timestamp,
                topic,
                value: payload.value,
                stage: GROWTH_STAGES[currentStageIndex].name,
                day: currentDay
            };

            sensorData.push(logEntry);
            document.getElementById('dataCount').textContent = sensorData.length;
        }

        function downloadCSV() {
            if (sensorData.length === 0) {
                alert('No data to download!');
                return;
            }

            let csv = 'Timestamp,Sensor,Value,Growth Stage,Day\n';
            sensorData.forEach(entry => {
                csv += `"${entry.timestamp}","${entry.topic}",${entry.value},"${entry.stage}",${entry.day}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `irrigation_data_${new Date().toISOString().replace(/:/g, '-')}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            addLog('CSV data exported successfully', 'success');
        }

        function downloadJSON() {
            if (sensorData.length === 0) {
                alert('No data to download!');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                currentStage: GROWTH_STAGES[currentStageIndex],
                currentDay: currentDay,
                totalIrrigations: irrigationCount,
                data: sensorData
            };

            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `irrigation_data_${new Date().toISOString().replace(/:/g, '-')}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            addLog('JSON data exported successfully', 'success');
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all logged data?')) {
                sensorData = [];
                document.getElementById('dataLog').innerHTML = '<div class="log-entry info">Data cleared. Waiting for new readings...</div>';
                document.getElementById('dataCount').textContent = '0';
                
                // Clear chart
                chart.data.labels = [];
                chart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                chart.update();
                
                addLog('All data cleared', 'warning');
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            initializeUI();
            connectMQTT();
            addLog('System initialized successfully', 'success');
        });
    </script>
</body>
</html>